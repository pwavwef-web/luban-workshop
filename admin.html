<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Luban Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 antialiased h-screen overflow-hidden">

    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4 bg-stone-50">
        <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <i data-lucide="utensils-crossed" class="h-10 w-10 text-red-700 mr-3"></i>
                    <h1 class="serif text-3xl font-bold text-stone-900">Luban <span class="text-red-700">Workshop</span>
                    </h1>
                </div>
                <p class="text-stone-600">Admin Dashboard</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Email Address</label>
                    <input type="email" id="email" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Password</label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div id="login-error" class="hidden text-red-700 text-sm text-center p-3 bg-red-50 rounded-md"></div>
                <button type="submit"
                    class="w-full bg-red-700 text-white py-3 rounded-md hover:bg-red-800 transition-colors font-medium">Sign
                    In</button>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden flex h-screen bg-stone-50">

        <!-- Mobile Menu Toggle Button -->
        <button id="mobile-menu-toggle" aria-label="Toggle navigation menu" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg text-stone-800 hover:bg-red-50 hover:text-red-700 transition-colors">
            <i data-lucide="menu" class="h-6 w-6"></i>
        </button>

        <!-- Mobile Overlay -->
        <div id="sidebar-overlay" tabindex="0" aria-label="Close sidebar" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>

        <aside id="sidebar" class="w-64 bg-white shadow-xl z-30 flex flex-col fixed md:static inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center px-6 border-b border-stone-100">
                <i data-lucide="utensils-crossed" class="h-6 w-6 text-red-700 mr-2"></i>
                <span class="serif font-bold text-xl text-stone-900">Luban Admin</span>
                <!-- Close button for mobile -->
                <button id="sidebar-close-btn" aria-label="Close menu" class="md:hidden ml-auto p-1 hover:bg-red-50 hover:text-red-700 rounded transition-colors">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="switchTab('menu')" id="tab-btn-menu"
                    class="w-full flex items-center px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
                    <span class="font-medium">Menu Manager</span>
                </button>

                <button onclick="switchTab('reservations')" id="tab-btn-reservations"
                    class="w-full flex items-center justify-between px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <div class="flex items-center">
                        <i data-lucide="calendar-clock" class="h-5 w-5 mr-3"></i>
                        <span class="font-medium">Reservations</span>
                    </div>
                    <span id="badge-reservations"
                        class="hidden h-2.5 w-2.5 bg-red-600 rounded-full ring-2 ring-white animate-pulse"></span>
                </button>

                <button onclick="switchTab('orders')" id="tab-btn-orders"
                    class="w-full flex items-center justify-between px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <div class="flex items-center">
                        <i data-lucide="shopping-bag" class="h-5 w-5 mr-3"></i>
                        <span class="font-medium">Orders</span>
                    </div>
                    <span id="badge-orders"
                        class="hidden h-2.5 w-2.5 bg-red-600 rounded-full ring-2 ring-white animate-pulse"></span>
                </button>
            </nav>

            <div class="p-4 border-t border-stone-100">
                <div class="flex items-center mb-3">
                    <div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center text-red-700">
                        <i data-lucide="chef-hat" class="h-6 w-6"></i>
                    </div>

                    <div class="ml-3">
                        <p class="text-sm font-bold text-stone-900">Admin</p>
                        <p id="user-email" class="text-xs text-stone-500 truncate w-32">admin@luban.com</p>
                    </div>
                </div>

                <button onclick="logout()"
                    class="w-full flex items-center justify-center px-4 py-2 border border-stone-200 rounded-md text-sm font-medium text-stone-600 hover:bg-stone-50 hover:text-red-700 transition-colors">
                    <i data-lucide="log-out" class="h-4 w-4 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-stone-50 p-4 md:p-8 pt-20 md:pt-8">

            <div id="view-menu" class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Menu Manager</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="seedDefaultMenu()"
                            class="px-4 py-2 bg-stone-700 text-white rounded-md hover:bg-stone-800 transition-colors font-medium shadow-sm flex items-center text-sm sm:text-base">
                            <i data-lucide="database" class="h-4 w-4 mr-2"></i> Seed Default Menu
                        </button>
                        <button onclick="showAddDishModal()"
                            class="px-4 py-2 bg-red-700 text-white rounded-md hover:bg-red-800 transition-colors font-medium shadow-sm flex items-center text-sm sm:text-base">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i> Add Dish
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Dish</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Category</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Price</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-items-table" class="bg-white divide-y divide-stone-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-reservations" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Reservations</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Guest</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Contact</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Date & Time</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Size</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservations-table" class="bg-white divide-y divide-stone-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-orders" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Incoming Orders</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Order ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Items</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table" class="bg-white divide-y divide-stone-200">
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-stone-500 italic">Waiting for new
                                    orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="dish-modal"
        class="hidden fixed inset-0 bg-stone-900 bg-opacity-75 flex items-center justify-center px-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="serif text-xl font-bold text-stone-900">Add Dish</h3>
                <button onclick="closeDishModal()" class="text-stone-400 hover:text-stone-600"><i data-lucide="x"
                        class="h-6 w-6"></i></button>
            </div>
            <form id="dish-form" class="space-y-4">
                <input type="hidden" id="dish-id">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Dish Name</label>
                    <input type="text" id="dish-name" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Category</label>
                        <select id="dish-category" required
                            class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-red-700 focus:outline-none">
                            <option value="soups">Soups</option>
                            <option value="starters">Starters</option>
                            <option value="beef-lamb">Beef &amp; Lamb</option>
                            <option value="pork">Pork</option>
                            <option value="chicken">Chicken</option>
                            <option value="seafood">Seafood</option>
                            <option value="rice">Rice</option>
                            <option value="noodles">Noodles</option>
                            <option value="dumplings">Dumplings</option>
                            <option value="veg">Vegetable</option>
                            <option value="mains">Mains</option>
                            <option value="appetizers">Appetizers</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Price ($)</label>
                        <input type="number" id="dish-price" step="0.01" required
                            class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-red-700 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Description</label>
                    <textarea id="dish-description" rows="3" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-red-700 focus:outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Image URL</label>
                    <input type="url" id="dish-image"
                        class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t border-stone-100 mt-2">
                    <button type="button" onclick="closeDishModal()"
                        class="px-4 py-2 border border-stone-300 text-stone-700 rounded-lg hover:bg-stone-50">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 shadow-sm">Save Dish</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxgdwU84vFNoCOUTl-HRdGYonLIcDaXFw",
            authDomain: "luban-workshop-restaurant.firebaseapp.com",
            projectId: "luban-workshop-restaurant",
            storageBucket: "luban-workshop-restaurant.firebasestorage.app",
            messagingSenderId: "360623290287",
            appId: "1:360623290287:web:89fae5ebbb342e5e13e15a",
            measurementId: "G-PZQ13BWZB3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Auth State ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;

                // Initialize Listeners
                listenToMenu();
                listenToReservations();
                listenToOrders();

                // Set default tab
                switchTab('menu');
                
                // Setup mobile sidebar event listeners
                const menuToggle = document.getElementById('mobile-menu-toggle');
                const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
                const overlay = document.getElementById('sidebar-overlay');
                
                menuToggle.addEventListener('click', toggleMobileSidebar);
                sidebarCloseBtn.addEventListener('click', toggleMobileSidebar);
                overlay.addEventListener('click', toggleMobileSidebar);
                overlay.addEventListener('keydown', handleOverlayKeydown);
                
                lucide.createIcons();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });

        // --- Navigation Logic ---
        const MOBILE_BREAKPOINT = 768; // Tailwind 'md:' breakpoint
        let isMobileSidebarOpen = false; // Track sidebar state

        function handleOverlayKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // Prevent page scroll on Space
                toggleMobileSidebar();
            }
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (isMobileSidebarOpen) {
                // Close sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                isMobileSidebarOpen = false;
            } else {
                // Open sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                isMobileSidebarOpen = true;
            }
        }

        function switchTab(tabName) {
            // Close mobile sidebar when switching tabs (only if it's open)
            if (window.innerWidth < MOBILE_BREAKPOINT && isMobileSidebarOpen) {
                toggleMobileSidebar();
            }
            
            // Hide all views
            ['menu', 'reservations', 'orders'].forEach(tab => {
                document.getElementById('view-' + tab).classList.add('hidden');

                // Reset Tab Styles
                const btn = document.getElementById('tab-btn-' + tab);
                btn.classList.remove('bg-red-50', 'text-red-700');
                btn.classList.add('text-stone-600');
            });

            // Show active view
            document.getElementById('view-' + tabName).classList.remove('hidden');

            // Set Active Tab Style
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            activeBtn.classList.add('bg-red-50', 'text-red-700');
            activeBtn.classList.remove('text-stone-600');
        }

        // --- Real-time Listeners (Red Dot Logic) ---

        function listenToMenu() {
            db.collection('menuItems').orderBy('name').onSnapshot(snapshot => {
                const tableBody = document.getElementById('menu-items-table');
                tableBody.innerHTML = '';

                snapshot.forEach(doc => {
                    const dish = doc.data();
                    const row = `
                        <tr class="hover:bg-stone-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${dish.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-stone-100 text-stone-800">${dish.category}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono">$${dish.price}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editDish('${doc.id}')" class="text-stone-400 hover:text-red-700 mr-3 transition-colors"><i data-lucide="edit" class="h-4 w-4"></i></button>
                                <button onclick="deleteDish('${doc.id}')" class="text-stone-400 hover:text-red-700 transition-colors"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                lucide.createIcons();
            });
        }

        function listenToReservations() {
            db.collection('reservations').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const tableBody = document.getElementById('reservations-table');
                tableBody.innerHTML = '';

                let pendingCount = 0;

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-stone-500 italic">No reservations yet.</td></tr>';
                }

                snapshot.forEach(doc => {
                    const res = doc.data();
                    const id = doc.id; // We need the ID to update it

                    if (res.status === 'pending') pendingCount++;

                    const statusColor = res.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const displayStatus = res.status ? res.status.charAt(0).toUpperCase() + res.status.slice(1) : 'Pending';

                    // Logic: If pending, show "Check" button. If completed, show "Undo" button.
                    let actionBtn = '';
                    if (res.status !== 'completed') {
                        actionBtn = `
                    <button onclick="updateReservationStatus('${id}', 'completed')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 p-2 rounded-full transition-colors" title="Mark Completed">
                        <i data-lucide="check" class="h-4 w-4"></i>
                    </button>`;
                    } else {
                        actionBtn = `
                    <button onclick="updateReservationStatus('${id}', 'pending')" class="text-stone-400 hover:text-stone-600 p-2 rounded-full transition-colors" title="Mark Pending">
                        <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
                    </button>`;
                    }

                    const row = `
                <tr class="hover:bg-stone-50 transition-colors border-b border-stone-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${res.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        <div>${res.phone}</div>
                        <div class="text-xs text-stone-400">${res.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        <div class="font-medium">${res.date}</div>
                        <div class="text-xs">${res.time}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${res.guests} Ppl</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${displayStatus}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${actionBtn}
                    </td>
                </tr>
            `;
                    tableBody.innerHTML += row;
                });

                // Toggle Red Dot
                const badge = document.getElementById('badge-reservations');
                if (pendingCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                // Re-initialize icons for the new buttons
                lucide.createIcons();
            });
        }

        async function updateReservationStatus(id, status) {
            try {
                await db.collection('reservations').doc(id).update({
                    status: status
                });
                // No need to reload page; onSnapshot will automatically update the UI!
                console.log(`Reservation ${id} updated to ${status}`);
            } catch (error) {
                console.error("Error updating status:", error);
                alert("Failed to update status. Check your internet connection.");
            }
        }

        function listenToOrders() {
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const tableBody = document.getElementById('orders-table');
                tableBody.innerHTML = '';
                
                let pendingCount = 0;

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-stone-500 italic">No orders received yet.</td></tr>';
                }

                snapshot.forEach(doc => {
                    const order = doc.data();
                    const id = doc.id;
                    
                    // Count 'pending' for Red Dot
                    if (order.status === 'pending' || !order.status) pendingCount++;

                    // Determine Status Colors
                    let statusClass = 'bg-stone-100 text-stone-800'; // Default
                    if (order.status === 'completed') statusClass = 'bg-green-100 text-green-800';
                    if (order.status === 'pending') statusClass = 'bg-yellow-100 text-yellow-800';
                    if (order.status === 'cancelled') statusClass = 'bg-red-100 text-red-800';

                    const itemsSummary = order.items ? order.items.map(i => `${i.quantity}x ${i.name}`).join(', ') : 'No items';

                    // Action Buttons Logic
                    let actions = '';
                    if (order.status !== 'completed' && order.status !== 'cancelled') {
                        // Show Complete and Cancel buttons for pending orders
                        actions = `
                            <button onclick="updateOrderStatus('${id}', 'completed')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 p-2 rounded-full mr-2 transition-colors" title="Mark Completed">
                                <i data-lucide="check" class="h-4 w-4"></i>
                            </button>
                            <button onclick="updateOrderStatus('${id}', 'cancelled')" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-2 rounded-full transition-colors" title="Cancel Order">
                                <i data-lucide="x" class="h-4 w-4"></i>
                            </button>
                        `;
                    } else {
                        // Show "Undo" button if completed or cancelled
                        actions = `
                            <button onclick="updateOrderStatus('${id}', 'pending')" class="text-stone-400 hover:text-stone-600 p-2 rounded-full transition-colors" title="Move back to Pending">
                                <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
                            </button>
                        `;
                    }

                    const row = `
                        <tr class="hover:bg-stone-50 transition-colors border-b border-stone-100">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-stone-500">#${id.slice(-6).toUpperCase()}</td>
                            <td class="px-6 py-4 text-sm text-stone-900 max-w-xs truncate" title="${itemsSummary}">${itemsSummary}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-stone-900">$${(order.total || 0).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${order.status ? order.status.toUpperCase() : 'PENDING'}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                ${actions}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                // Toggle Red Dot
                const badge = document.getElementById('badge-orders');
                if (pendingCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                lucide.createIcons();
            });
        }

        async function updateOrderStatus(id, status) {
            try {
                if (status === 'cancelled' && !confirm("Are you sure you want to cancel this order?")) return;
                
                await db.collection('orders').doc(id).update({
                    status: status
                });
                console.log(`Order ${id} updated to ${status}`);
            } catch (error) {
                console.error("Error updating order:", error);
                alert("Could not update order.");
            }
        }

        // --- Auth Functions ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('login-error').classList.add('hidden');
            } catch (error) {
                const errDiv = document.getElementById('login-error');
                errDiv.textContent = error.message;
                errDiv.classList.remove('hidden');
            }
        });

        function logout() { auth.signOut(); }

        // --- Dish CRUD Functions (Same as before) ---
        function showAddDishModal() {
            document.getElementById('modal-title').textContent = 'Add Dish';
            document.getElementById('dish-form').reset();
            document.getElementById('dish-id').value = '';
            document.getElementById('dish-modal').classList.remove('hidden');
        }
        function closeDishModal() { document.getElementById('dish-modal').classList.add('hidden'); }

        async function editDish(id) {
            const doc = await db.collection('menuItems').doc(id).get();
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('dish-id').value = id;
                document.getElementById('dish-name').value = d.name;
                document.getElementById('dish-category').value = d.category;
                document.getElementById('dish-price').value = d.price;
                document.getElementById('dish-description').value = d.description;
                document.getElementById('dish-image').value = d.image || '';
                document.getElementById('modal-title').textContent = 'Edit Dish';
                document.getElementById('dish-modal').classList.remove('hidden');
            }
        }

        async function deleteDish(id) {
            if (confirm('Delete this dish?')) await db.collection('menuItems').doc(id).delete();
        }

        document.getElementById('dish-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('dish-id').value;
            const data = {
                name: document.getElementById('dish-name').value,
                category: document.getElementById('dish-category').value,
                price: parseFloat(document.getElementById('dish-price').value),
                description: document.getElementById('dish-description').value,
                image: document.getElementById('dish-image').value
            };

            if (id) await db.collection('menuItems').doc(id).update(data);
            else await db.collection('menuItems').add(data);
            closeDishModal();
        });

        async function seedDefaultMenu() {
            if (!confirm('This will add all default menu items to Firestore (existing items will not be removed). Continue?')) return;
            const defaultItems = [
                { name: 'Chicken & Sweet Corn Soup', category: 'soups', price: 40, description: 'A smooth, savoury broth with tender chicken and sweet corn', image: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?w=400&h=300&fit=crop&auto=format' },
                { name: 'Hot & Sour Soup', category: 'soups', price: 40, description: 'Traditional Chinese hot and sour broth with tofu and vegetables', image: 'https://images.unsplash.com/photo-1555126634-323283e090fa?w=400&h=300&fit=crop&auto=format' },
                { name: 'Beef Spring Rolls (3 pcs)', category: 'starters', price: 30, description: 'Crispy golden rolls filled with seasoned beef', image: 'https://images.unsplash.com/photo-1606525437394-f0b0df43c5e0?w=400&h=300&fit=crop&auto=format' },
                { name: 'Vegetable Spring Rolls (3 pcs)', category: 'starters', price: 25, description: 'Light and crispy rolls packed with fresh vegetables', image: 'https://images.unsplash.com/photo-1563245372-f89ffd94b5eb?w=400&h=300&fit=crop&auto=format' },
                { name: 'Beef Samosa (5 pcs)', category: 'starters', price: 30, description: 'Golden pastry triangles filled with spiced beef', image: 'https://images.unsplash.com/photo-1601050690597-df0568f70950?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fish Samosa (5 pcs)', category: 'starters', price: 30, description: 'Crispy pastry triangles with seasoned fish filling', image: 'https://images.unsplash.com/photo-1601050690597-df0568f70950?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fried Chicken Pieces (6 pcs)', category: 'starters', price: 65, description: 'Juicy fried chicken bites with a crispy coating', image: 'https://images.unsplash.com/photo-1562967915-6ba607ff4a08?w=400&h=300&fit=crop&auto=format' },
                { name: 'Special Chicken Wings', category: 'starters', price: 65, description: 'Tender chicken wings marinated in our special sauce', image: 'https://images.unsplash.com/photo-1527477396000-e27163b481c2?w=400&h=300&fit=crop&auto=format' },
                { name: 'Golden Fried Prawns', category: 'starters', price: 90, description: 'Succulent prawns fried to a golden crisp', image: 'https://images.unsplash.com/photo-1559410545-0bdb565a7e6b?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fried Squid in Spicy Salt', category: 'starters', price: 85, description: 'Tender squid rings seasoned with spicy salt', image: 'https://images.unsplash.com/photo-1617622141573-0e6db8c3dc7a?w=400&h=300&fit=crop&auto=format' },
                { name: 'Shredded Beef with Green Pepper & Onion', category: 'beef-lamb', price: 110, description: 'Tender shredded beef stir-fried with green pepper and onion', image: 'https://images.unsplash.com/photo-1529193591-8c9ae9699b13?w=400&h=300&fit=crop&auto=format' },
                { name: 'Sliced Beef in Curry Sauce', category: 'beef-lamb', price: 110, description: 'Sliced beef simmered in a rich, aromatic curry sauce', image: 'https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=400&h=300&fit=crop&auto=format' },
                { name: 'Beef in Oyster Sauce', category: 'beef-lamb', price: 110, description: 'Tender beef slices coated in a savoury oyster sauce', image: 'https://images.unsplash.com/photo-1529193591-8c9ae9699b13?w=400&h=300&fit=crop&auto=format' },
                { name: 'Crispy Chilli Beef', category: 'beef-lamb', price: 85, description: 'Crispy strips of beef tossed in a sweet chilli glaze', image: 'https://images.unsplash.com/photo-1562967916-eb82221dfb92?w=400&h=300&fit=crop&auto=format' },
                { name: 'Mongolian Shallot Lamb', category: 'beef-lamb', price: 115, description: 'Succulent lamb stir-fried with shallots in Mongolian style', image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=300&fit=crop&auto=format' },
                { name: 'Lamb Chops', category: 'beef-lamb', price: 85, description: 'Seasoned lamb chops grilled to perfection', image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=300&fit=crop&auto=format' },
                { name: 'Sweet & Sour Pork', category: 'pork', price: 90, description: 'Crispy pork pieces in a tangy sweet and sour sauce', image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop&auto=format' },
                { name: 'Pork Sichuan Style', category: 'pork', price: 90, description: 'Sliced pork in a bold, numbing Sichuan sauce', image: 'https://images.unsplash.com/photo-1547592180-85f173990554?w=400&h=300&fit=crop&auto=format' },
                { name: 'Pork in Chilli Sauce', category: 'pork', price: 90, description: 'Tender pork coated in a fiery chilli sauce', image: 'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=400&h=300&fit=crop&auto=format' },
                { name: 'Pork in Oyster Sauce', category: 'pork', price: 90, description: 'Succulent pork slices glazed in umami oyster sauce', image: 'https://images.unsplash.com/photo-1529193591-8c9ae9699b13?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fried Pork Ribs', category: 'pork', price: 75, description: 'Crispy fried pork ribs with a savoury coating', image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=300&fit=crop&auto=format' },
                { name: 'Sweet & Sour Chicken', category: 'chicken', price: 100, description: 'Tender chicken in a classic sweet and sour sauce', image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop&auto=format' },
                { name: 'Chicken Sichuan Sauce', category: 'chicken', price: 100, description: 'Chicken stir-fried in a spicy Sichuan sauce', image: 'https://images.unsplash.com/photo-1604908176997-7f81f85f7c8e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Chicken in Curry Sauce', category: 'chicken', price: 100, description: 'Juicy chicken pieces simmered in aromatic curry sauce', image: 'https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=400&h=300&fit=crop&auto=format' },
                { name: 'Chicken in Oyster Sauce', category: 'chicken', price: 100, description: 'Tender chicken glazed in a rich oyster sauce', image: 'https://images.unsplash.com/photo-1562967915-6ba607ff4a08?w=400&h=300&fit=crop&auto=format' },
                { name: 'Squid in Luban Chilli Sauce', category: 'seafood', price: 120, description: 'Tender squid in our signature Luban chilli sauce', image: 'https://images.unsplash.com/photo-1617622141573-0e6db8c3dc7a?w=400&h=300&fit=crop&auto=format' },
                { name: 'Squid in Sichuan Sauce', category: 'seafood', price: 120, description: 'Squid pieces tossed in a bold Sichuan sauce', image: 'https://images.unsplash.com/photo-1617622141573-0e6db8c3dc7a?w=400&h=300&fit=crop&auto=format' },
                { name: 'Squid in Garlic Sauce', category: 'seafood', price: 120, description: 'Succulent squid cooked in a fragrant garlic sauce', image: 'https://images.unsplash.com/photo-1617622141573-0e6db8c3dc7a?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fish Fillet in Chilli Sauce', category: 'seafood', price: 115, description: 'Fresh fish fillet bathed in a spicy chilli sauce', image: 'https://images.unsplash.com/photo-1580476262798-bddd9f4b7369?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fish Fillet in Vegetable Sauce', category: 'seafood', price: 115, description: 'Delicate fish fillet served in a light vegetable sauce', image: 'https://images.unsplash.com/photo-1580476262798-bddd9f4b7369?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fish Fillet in Sichuan Sauce', category: 'seafood', price: 115, description: 'Fish fillet slow-cooked in a numbing Sichuan sauce', image: 'https://images.unsplash.com/photo-1580476262798-bddd9f4b7369?w=400&h=300&fit=crop&auto=format' },
                { name: 'Sweet & Sour Fish Fillet', category: 'seafood', price: 115, description: 'Crispy fish fillet in a sweet and sour glaze', image: 'https://images.unsplash.com/photo-1580476262798-bddd9f4b7369?w=400&h=300&fit=crop&auto=format' },
                { name: 'Prawns in Chilli Sauce', category: 'seafood', price: 155, description: 'Juicy prawns tossed in a fiery chilli sauce', image: 'https://images.unsplash.com/photo-1559410545-0bdb565a7e6b?w=400&h=300&fit=crop&auto=format' },
                { name: 'Prawns in Curry Sauce', category: 'seafood', price: 155, description: 'Succulent prawns in a rich, aromatic curry sauce', image: 'https://images.unsplash.com/photo-1559410545-0bdb565a7e6b?w=400&h=300&fit=crop&auto=format' },
                { name: 'Prawns in Sichuan Sauce', category: 'seafood', price: 155, description: 'Plump prawns bathed in a bold Sichuan sauce', image: 'https://images.unsplash.com/photo-1559410545-0bdb565a7e6b?w=400&h=300&fit=crop&auto=format' },
                { name: 'Special Seafood in Sichuan Sauce', category: 'seafood', price: 170, description: "Chef's selection of seafood in a signature Sichuan sauce", image: 'https://images.unsplash.com/photo-1559410545-0bdb565a7e6b?w=400&h=300&fit=crop&auto=format' },
                { name: 'Steamed Rice', category: 'rice', price: 29, description: 'Fluffy steamed white rice', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Special Jollof Rice', category: 'rice', price: 50, description: 'Our special take on the classic West African jollof rice', image: 'https://images.unsplash.com/photo-1596560548464-f010549b84d7?w=400&h=300&fit=crop&auto=format' },
                { name: 'Combo Fried Rice', category: 'rice', price: 50, description: 'Wok-fried rice with a combination of meats and vegetables', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Shrimp Fried Rice', category: 'rice', price: 50, description: 'Fragrant fried rice loaded with juicy shrimp', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Egg Fried Rice', category: 'rice', price: 40, description: 'Classic fried rice tossed with eggs', image: 'https://images.unsplash.com/photo-1609501676725-7186f017a4b7?w=400&h=300&fit=crop&auto=format' },
                { name: 'Beef Fried Rice', category: 'rice', price: 45, description: 'Fried rice with tender slices of beef', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Chicken Fried Rice', category: 'rice', price: 45, description: 'Wok-fried rice with seasoned chicken pieces', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Seafood Fried Rice', category: 'rice', price: 85, description: 'Fried rice packed with mixed seafood', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Pork Fried Rice', category: 'rice', price: 45, description: 'Fragrant fried rice with tender pork pieces', image: 'https://images.unsplash.com/photo-1603133872634-6e01db44284e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Vegetable Noodles', category: 'noodles', price: 45, description: 'Wok-tossed noodles with fresh garden vegetables', image: 'https://images.unsplash.com/photo-1557872943-16a5ac26437e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Special Noodles', category: 'noodles', price: 80, description: 'Our signature noodle dish with a special blend of flavours', image: 'https://images.unsplash.com/photo-1557872943-16a5ac26437e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Singapore Noodles', category: 'noodles', price: 80, description: 'Stir-fried rice vermicelli with curry, vegetables and egg', image: 'https://images.unsplash.com/photo-1567529692333-de9fd6772897?w=400&h=300&fit=crop&auto=format' },
                { name: 'Seafood Noodles', category: 'noodles', price: 100, description: 'Noodles tossed with a medley of fresh seafood', image: 'https://images.unsplash.com/photo-1557872943-16a5ac26437e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Chicken Noodles', category: 'noodles', price: 60, description: 'Stir-fried noodles with succulent chicken pieces', image: 'https://images.unsplash.com/photo-1557872943-16a5ac26437e?w=400&h=300&fit=crop&auto=format' },
                { name: 'Steamed Pork Dumpling', category: 'dumplings', price: 30, description: 'Handcrafted steamed dumplings with seasoned pork filling', image: 'https://images.unsplash.com/photo-1563245372-f89ffd94b5eb?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fried Pork Dumpling', category: 'dumplings', price: 30, description: 'Pan-fried dumplings with a crispy bottom and juicy pork filling', image: 'https://images.unsplash.com/photo-1563245372-f89ffd94b5eb?w=400&h=300&fit=crop&auto=format' },
                { name: 'Steamed Beef Dumpling', category: 'dumplings', price: 30, description: 'Delicate steamed dumplings filled with seasoned beef', image: 'https://images.unsplash.com/photo-1563245372-f89ffd94b5eb?w=400&h=300&fit=crop&auto=format' },
                { name: 'Fried Beef Dumpling', category: 'dumplings', price: 30, description: 'Crispy pan-fried dumplings with a savoury beef filling', image: 'https://images.unsplash.com/photo-1563245372-f89ffd94b5eb?w=400&h=300&fit=crop&auto=format' },
                { name: 'Mixed Vegetable Sauce', category: 'veg', price: 40, description: 'Fresh seasonal vegetables stir-fried in a light sauce', image: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=300&fit=crop&auto=format' },
            ];
            try {
                const batch = db.batch();
                defaultItems.forEach(item => {
                    const ref = db.collection('menuItems').doc();
                    batch.set(ref, item);
                });
                await batch.commit();
                alert('Default menu items added successfully!');
            } catch (error) {
                console.error('Error seeding menu:', error);
                alert('Failed to seed menu items: ' + error.message);
            }
        }

    </script>
</body>

</html>
