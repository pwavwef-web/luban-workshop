<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Luban Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 antialiased h-screen overflow-hidden">

    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4 bg-stone-50">
        <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <i data-lucide="utensils-crossed" class="h-10 w-10 text-red-700 mr-3"></i>
                    <h1 class="serif text-3xl font-bold text-stone-900">Luban <span class="text-red-700">Workshop</span>
                    </h1>
                </div>
                <p class="text-stone-600">Admin Dashboard</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Email Address</label>
                    <input type="email" id="email" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Password</label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-red-700 focus:outline-none">
                </div>
                <div id="login-error" class="hidden text-red-700 text-sm text-center p-3 bg-red-50 rounded-md"></div>
                <button type="submit"
                    class="w-full bg-red-700 text-white py-3 rounded-md hover:bg-red-800 transition-colors font-medium">Sign
                    In</button>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden flex h-screen bg-stone-50">

        <!-- Mobile Menu Toggle Button -->
        <button id="mobile-menu-toggle" aria-label="Toggle navigation menu" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg text-stone-800 hover:bg-red-50 hover:text-red-700 transition-colors">
            <i data-lucide="menu" class="h-6 w-6"></i>
        </button>

        <!-- Mobile Overlay -->
        <div id="sidebar-overlay" tabindex="0" aria-label="Close sidebar" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>

        <aside id="sidebar" class="w-64 bg-white shadow-xl z-30 flex flex-col fixed md:static inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center px-6 border-b border-stone-100">
                <i data-lucide="utensils-crossed" class="h-6 w-6 text-red-700 mr-2"></i>
                <span class="serif font-bold text-xl text-stone-900">Luban Admin</span>
                <!-- Close button for mobile -->
                <button id="sidebar-close-btn" aria-label="Close menu" class="md:hidden ml-auto p-1 hover:bg-red-50 hover:text-red-700 rounded transition-colors">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="switchTab('menu')" id="tab-btn-menu"
                    class="w-full flex items-center px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
                    <span class="font-medium">Menu Manager</span>
                </button>

                <button onclick="switchTab('reservations')" id="tab-btn-reservations"
                    class="w-full flex items-center justify-between px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <div class="flex items-center">
                        <i data-lucide="calendar-clock" class="h-5 w-5 mr-3"></i>
                        <span class="font-medium">Reservations</span>
                    </div>
                    <span id="badge-reservations"
                        class="hidden h-2.5 w-2.5 bg-red-600 rounded-full ring-2 ring-white animate-pulse"></span>
                </button>

                <button onclick="switchTab('orders')" id="tab-btn-orders"
                    class="w-full flex items-center justify-between px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <div class="flex items-center">
                        <i data-lucide="shopping-bag" class="h-5 w-5 mr-3"></i>
                        <span class="font-medium">Orders</span>
                    </div>
                    <span id="badge-orders"
                        class="hidden h-2.5 w-2.5 bg-red-600 rounded-full ring-2 ring-white animate-pulse"></span>
                </button>

                <button onclick="switchTab('admin')" id="tab-btn-admin"
                    class="w-full flex items-center px-4 py-3 text-stone-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-colors group">
                    <i data-lucide="shield" class="h-5 w-5 mr-3"></i>
                    <span class="font-medium">Admin</span>
                </button>
            </nav>

            <div class="p-4 border-t border-stone-100">
                <div class="flex items-center mb-3">
                    <div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center text-red-700">
                        <i data-lucide="chef-hat" class="h-6 w-6"></i>
                    </div>

                    <div class="ml-3">
                        <p class="text-sm font-bold text-stone-900">Admin</p>
                        <p id="user-email" class="text-xs text-stone-500 truncate w-32">admin@luban.com</p>
                    </div>
                </div>

                <button onclick="logout()"
                    class="w-full flex items-center justify-center px-4 py-2 border border-stone-200 rounded-md text-sm font-medium text-stone-600 hover:bg-stone-50 hover:text-red-700 transition-colors">
                    <i data-lucide="log-out" class="h-4 w-4 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-stone-50 p-4 md:p-8 pt-20 md:pt-8">

            <div id="view-menu" class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Menu Manager</h2>
                    <p class="text-sm text-stone-500">Toggle dish visibility on the main website.</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Dish</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Category</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Price</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-items-table" class="bg-white divide-y divide-stone-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-reservations" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Reservations</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Guest</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Contact</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Date & Time</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Size</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservations-table" class="bg-white divide-y divide-stone-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-orders" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Incoming Orders</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Order ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Items</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table" class="bg-white divide-y divide-stone-200">
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-stone-500 italic">Waiting for new
                                    orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Management Tab -->
            <div id="view-admin" class="hidden space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="serif text-2xl sm:text-3xl font-bold text-stone-900">Admin Management</h2>
                    <p class="text-sm text-stone-500">Promote or revoke admin access for users.</p>
                </div>

                <!-- Promote User Form -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                    <h3 class="text-base font-semibold text-stone-800 mb-4">Promote User to Admin</h3>
                    <form id="promote-form" class="flex flex-col sm:flex-row gap-3">
                        <input type="email" id="promote-email" placeholder="user@example.com" required
                            class="flex-1 px-4 py-2 border border-stone-300 rounded-md text-sm focus:ring-2 focus:ring-red-700 focus:outline-none">
                        <button type="submit"
                            class="px-5 py-2 bg-red-700 text-white text-sm font-medium rounded-md hover:bg-red-800 transition-colors whitespace-nowrap">
                            Grant Admin Access
                        </button>
                    </form>
                    <div id="promote-message" class="hidden mt-3 text-sm p-3 rounded-md"></div>
                </div>

                <!-- Current Admins List -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider">Promoted At</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admins-table" class="bg-white divide-y divide-stone-200">
                            <tr><td colspan="3" class="px-6 py-8 text-center text-stone-500 italic">Loading admins...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxgdwU84vFNoCOUTl-HRdGYonLIcDaXFw",
            authDomain: "luban-workshop-restaurant.firebaseapp.com",
            projectId: "luban-workshop-restaurant",
            storageBucket: "luban-workshop-restaurant.firebasestorage.app",
            messagingSenderId: "360623290287",
            appId: "1:360623290287:web:89fae5ebbb342e5e13e15a",
            measurementId: "G-PZQ13BWZB3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Auth State ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                // Verify admin status before showing the dashboard
                let adminAccess = false;
                try {
                    const idTokenResult = await user.getIdTokenResult();
                    if (idTokenResult.claims.admin === true) {
                        adminAccess = true;
                    } else if (user.email === 'admin@luban.com') {
                        adminAccess = true;
                    } else {
                        // Check the Firestore admins collection
                        const adminDoc = await db.collection('admins').doc(user.email).get();
                        adminAccess = adminDoc.exists;
                    }
                } catch (err) {
                    // Verification failed – treat as non-admin (adminAccess stays false)
                    console.error('Admin check failed:', err);
                }

                // Block access for non-admins (also covers failed verification above)
                if (!adminAccess) {
                    await auth.signOut();
                    const errDiv = document.getElementById('login-error');
                    errDiv.textContent = 'Access denied. You do not have admin privileges.';
                    errDiv.classList.remove('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('admin-dashboard').classList.add('hidden');
                    return;
                }

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;

                // Initialize Listeners
                listenToMenu();
                listenToReservations();
                listenToOrders();

                // Set default tab
                switchTab('menu');
                
                // Setup mobile sidebar event listeners
                const menuToggle = document.getElementById('mobile-menu-toggle');
                const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
                const overlay = document.getElementById('sidebar-overlay');
                
                menuToggle.addEventListener('click', toggleMobileSidebar);
                sidebarCloseBtn.addEventListener('click', toggleMobileSidebar);
                overlay.addEventListener('click', toggleMobileSidebar);
                overlay.addEventListener('keydown', handleOverlayKeydown);
                
                lucide.createIcons();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });

        // --- Navigation Logic ---
        const MOBILE_BREAKPOINT = 768; // Tailwind 'md:' breakpoint
        let isMobileSidebarOpen = false; // Track sidebar state

        function handleOverlayKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // Prevent page scroll on Space
                toggleMobileSidebar();
            }
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (isMobileSidebarOpen) {
                // Close sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                isMobileSidebarOpen = false;
            } else {
                // Open sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                isMobileSidebarOpen = true;
            }
        }

        function switchTab(tabName) {
            // Close mobile sidebar when switching tabs (only if it's open)
            if (window.innerWidth < MOBILE_BREAKPOINT && isMobileSidebarOpen) {
                toggleMobileSidebar();
            }
            
            // Hide all views
            ['menu', 'reservations', 'orders', 'admin'].forEach(tab => {
                document.getElementById('view-' + tab).classList.add('hidden');

                // Reset Tab Styles
                const btn = document.getElementById('tab-btn-' + tab);
                btn.classList.remove('bg-red-50', 'text-red-700');
                btn.classList.add('text-stone-600');
            });

            // Show active view
            document.getElementById('view-' + tabName).classList.remove('hidden');

            // Set Active Tab Style
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            activeBtn.classList.add('bg-red-50', 'text-red-700');
            activeBtn.classList.remove('text-stone-600');

            // Load admins list when Admin tab is opened
            if (tabName === 'admin') loadAdmins();
        }

        // --- Hardcoded Menu ---
        const HARDCODED_MENU = [
            { id: 'SP1', name: 'Chicken & Sweet Corn Soup', category: 'soups', price: 40 },
            { id: 'SP2', name: 'Hot & Sour Soup', category: 'soups', price: 40 },
            { id: 'S1', name: 'Beef Spring Rolls (3 pcs)', category: 'starters', price: 30 },
            { id: 'S2', name: 'Vegetable Spring Rolls (3 pcs)', category: 'starters', price: 25 },
            { id: 'S3', name: 'Beef Samosa (5 pcs)', category: 'starters', price: 30 },
            { id: 'S4', name: 'Fish Samosa (5 pcs)', category: 'starters', price: 30 },
            { id: 'S5', name: 'Fried Chicken Pieces (6 pcs)', category: 'starters', price: 65 },
            { id: 'S6', name: 'Special Chicken Wings', category: 'starters', price: 65 },
            { id: 'S7', name: 'Golden Fried Prawns', category: 'starters', price: 90 },
            { id: 'S8', name: 'Fried Squid in Spicy Salt', category: 'starters', price: 85 },
            { id: 'B1', name: 'Shredded Beef with Green Pepper & Onion', category: 'beef-lamb', price: 110 },
            { id: 'B2', name: 'Beef in Sichuan Sauce', category: 'beef-lamb', price: 110 },
            { id: 'B3', name: 'Sliced Beef in Curry Sauce', category: 'beef-lamb', price: 110 },
            { id: 'B4', name: 'Beef in Oyster Sauce', category: 'beef-lamb', price: 110 },
            { id: 'B5', name: 'Crispy Chilli Beef', category: 'beef-lamb', price: 85 },
            { id: 'B6', name: 'Mongolian Shallot Lamb', category: 'beef-lamb', price: 115 },
            { id: 'B7', name: 'Lamb Chops', category: 'beef-lamb', price: 85 },
            { id: 'P1', name: 'Sweet & Sour Pork', category: 'pork', price: 90 },
            { id: 'P2', name: 'Pork Sichuan Style', category: 'pork', price: 90 },
            { id: 'P3', name: 'Pork in Chilli Sauce', category: 'pork', price: 90 },
            { id: 'P4', name: 'Pork in Oyster Sauce', category: 'pork', price: 90 },
            { id: 'P5', name: 'Fried Pork Ribs', category: 'pork', price: 75 },
            { id: 'K1', name: 'Sweet & Sour Chicken', category: 'chicken', price: 100 },
            { id: 'K2', name: 'Chicken Sichuan Sauce', category: 'chicken', price: 100 },
            { id: 'K3', name: 'Chicken in Curry Sauce', category: 'chicken', price: 100 },
            { id: 'K4', name: 'Chicken in Oyster Sauce', category: 'chicken', price: 100 },
            { id: 'Q1', name: 'Squid in Luban Chilli Sauce', category: 'seafood', price: 120 },
            { id: 'Q2', name: 'Squid in Sichuan Sauce', category: 'seafood', price: 120 },
            { id: 'Q3', name: 'Squid in Garlic Sauce', category: 'seafood', price: 120 },
            { id: 'F1', name: 'Fish Fillet in Chilli Sauce', category: 'seafood', price: 115 },
            { id: 'F2', name: 'Fish Fillet in Vegetable Sauce', category: 'seafood', price: 115 },
            { id: 'F3', name: 'Fish Fillet in Sichuan Sauce', category: 'seafood', price: 115 },
            { id: 'F4', name: 'Sweet & Sour Fish Fillet', category: 'seafood', price: 115 },
            { id: 'PR1', name: 'Prawns in Chilli Sauce', category: 'seafood', price: 155 },
            { id: 'PR2', name: 'Prawns in Curry Sauce', category: 'seafood', price: 155 },
            { id: 'PR3', name: 'Prawns in Sichuan Sauce', category: 'seafood', price: 155 },
            { id: 'SF1', name: 'Special Seafood in Sichuan Sauce', category: 'seafood', price: 170 },
            { id: 'R1', name: 'Steamed Rice', category: 'rice', price: 29 },
            { id: 'R2', name: 'Special Jollof Rice', category: 'rice', price: 50 },
            { id: 'R3', name: 'Combo Fried Rice', category: 'rice', price: 50 },
            { id: 'R4', name: 'Shrimp Fried Rice', category: 'rice', price: 50 },
            { id: 'RS', name: 'Egg Fried Rice', category: 'rice', price: 40 },
            { id: 'R6', name: 'Beef Fried Rice', category: 'rice', price: 45 },
            { id: 'R7', name: 'Chicken Fried Rice', category: 'rice', price: 45 },
            { id: 'R8', name: 'Seafood Fried Rice', category: 'rice', price: 85 },
            { id: 'R9', name: 'Pork Fried Rice', category: 'rice', price: 45 },
            { id: 'N1', name: 'Vegetable Noodles', category: 'noodles', price: 45 },
            { id: 'N2', name: 'Special Noodles', category: 'noodles', price: 80 },
            { id: 'N4', name: 'Singapore Noodles', category: 'noodles', price: 80 },
            { id: 'N5', name: 'Seafood Noodles', category: 'noodles', price: 100 },
            { id: 'N6', name: 'Chicken Noodles', category: 'noodles', price: 60 },
            { id: 'D1', name: 'Steamed Pork Dumpling', category: 'dumplings', price: 30 },
            { id: 'D2', name: 'Fried Pork Dumpling', category: 'dumplings', price: 30 },
            { id: 'D3', name: 'Steamed Beef Dumpling', category: 'dumplings', price: 30 },
            { id: 'D4', name: 'Fried Beef Dumpling', category: 'dumplings', price: 30 },
            { id: 'V1', name: 'Mixed Vegetable Sauce', category: 'veg', price: 40 },
        ];

        // --- Real-time Listeners (Red Dot Logic) ---

        function listenToMenu() {
            db.collection('dishAvailability').onSnapshot(snapshot => {
                const hiddenIds = new Set();
                snapshot.forEach(doc => {
                    if (doc.data().hidden === true) hiddenIds.add(doc.id);
                });

                const tableBody = document.getElementById('menu-items-table');
                tableBody.innerHTML = '';

                HARDCODED_MENU.forEach(dish => {
                    const isHidden = hiddenIds.has(dish.id);
                    const statusBadge = isHidden
                        ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Hidden</span>'
                        : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Visible</span>';
                    const toggleIcon = isHidden ? 'eye' : 'eye-off';
                    const toggleTitle = isHidden ? 'Show on website' : 'Hide from website';
                    const row = `
                        <tr class="hover:bg-stone-50 transition-colors${isHidden ? ' opacity-60' : ''}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${dish.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-stone-100 text-stone-800">${dish.category}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono">₵${dish.price}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="toggleDishVisibility('${dish.id}', ${isHidden})" class="text-stone-400 hover:text-red-700 transition-colors" title="${toggleTitle}"><i data-lucide="${toggleIcon}" class="h-4 w-4"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                lucide.createIcons();
            });
        }

        async function toggleDishVisibility(id, currentlyHidden) {
            try {
                await db.collection('dishAvailability').doc(id).set({ hidden: !currentlyHidden });
            } catch (error) {
                console.error('Error toggling dish visibility:', error);
                alert('Failed to update dish visibility. Please try again.');
            }
        }

        function listenToReservations() {
            db.collection('reservations').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const tableBody = document.getElementById('reservations-table');
                tableBody.innerHTML = '';

                let pendingCount = 0;

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-stone-500 italic">No reservations yet.</td></tr>';
                }

                snapshot.forEach(doc => {
                    const res = doc.data();
                    const id = doc.id; // We need the ID to update it

                    if (res.status === 'pending') pendingCount++;

                    const statusColor = res.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const displayStatus = res.status ? res.status.charAt(0).toUpperCase() + res.status.slice(1) : 'Pending';

                    // Logic: If pending, show "Check" button. If completed, show "Undo" button.
                    let actionBtn = '';
                    if (res.status !== 'completed') {
                        actionBtn = `
                    <button onclick="updateReservationStatus('${id}', 'completed')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 p-2 rounded-full transition-colors" title="Mark Completed">
                        <i data-lucide="check" class="h-4 w-4"></i>
                    </button>`;
                    } else {
                        actionBtn = `
                    <button onclick="updateReservationStatus('${id}', 'pending')" class="text-stone-400 hover:text-stone-600 p-2 rounded-full transition-colors" title="Mark Pending">
                        <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
                    </button>`;
                    }

                    const row = `
                <tr class="hover:bg-stone-50 transition-colors border-b border-stone-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${res.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        <div>${res.phone}</div>
                        <div class="text-xs text-stone-400">${res.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        <div class="font-medium">${res.date}</div>
                        <div class="text-xs">${res.time}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${res.guests} Ppl</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${displayStatus}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${actionBtn}
                    </td>
                </tr>
            `;
                    tableBody.innerHTML += row;
                });

                // Toggle Red Dot
                const badge = document.getElementById('badge-reservations');
                if (pendingCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                // Re-initialize icons for the new buttons
                lucide.createIcons();
            });
        }

        async function updateReservationStatus(id, status) {
            try {
                await db.collection('reservations').doc(id).update({
                    status: status
                });
                // No need to reload page; onSnapshot will automatically update the UI!
                console.log(`Reservation ${id} updated to ${status}`);
            } catch (error) {
                console.error("Error updating status:", error);
                alert("Failed to update status. Check your internet connection.");
            }
        }

        function listenToOrders() {
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const tableBody = document.getElementById('orders-table');
                tableBody.innerHTML = '';
                
                let pendingCount = 0;

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-stone-500 italic">No orders received yet.</td></tr>';
                }

                snapshot.forEach(doc => {
                    const order = doc.data();
                    const id = doc.id;
                    
                    // Count 'pending' for Red Dot
                    if (order.status === 'pending' || !order.status) pendingCount++;

                    // Determine Status Colors
                    let statusClass = 'bg-stone-100 text-stone-800'; // Default
                    if (order.status === 'completed') statusClass = 'bg-green-100 text-green-800';
                    if (order.status === 'pending') statusClass = 'bg-yellow-100 text-yellow-800';
                    if (order.status === 'cancelled') statusClass = 'bg-red-100 text-red-800';

                    const itemsSummary = order.items ? order.items.map(i => `${i.quantity}x ${i.name}`).join(', ') : 'No items';
                    const itemsDetail = order.items
                        ? order.items.map(i => `<div class="py-0.5"><span class="font-bold text-stone-600">${i.quantity}&times;</span> ${i.name}</div>`).join('')
                        : '<div class="text-stone-400 italic">No items</div>';

                    // Action Buttons Logic
                    let actions = '';
                    if (order.status !== 'completed' && order.status !== 'cancelled') {
                        // Show Complete and Cancel buttons for pending orders
                        actions = `
                            <button onclick="updateOrderStatus('${id}', 'completed')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 p-2 rounded-full mr-2 transition-colors" title="Mark Completed">
                                <i data-lucide="check" class="h-4 w-4"></i>
                            </button>
                            <button onclick="updateOrderStatus('${id}', 'cancelled')" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-2 rounded-full transition-colors" title="Cancel Order">
                                <i data-lucide="x" class="h-4 w-4"></i>
                            </button>
                        `;
                    } else {
                        // Show "Undo" button if completed or cancelled
                        actions = `
                            <button onclick="updateOrderStatus('${id}', 'pending')" class="text-stone-400 hover:text-stone-600 p-2 rounded-full transition-colors" title="Move back to Pending">
                                <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
                            </button>
                        `;
                    }

                    const row = `
                        <tr class="hover:bg-stone-50 transition-colors border-b border-stone-100">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-stone-500">#${id.slice(-6).toUpperCase()}</td>
                            <td class="px-6 py-4 text-sm text-stone-900 max-w-xs">
                                <div class="truncate">${itemsSummary}</div>
                                <button onclick="toggleOrderDetails('${id}')" class="text-xs text-red-600 hover:text-red-800 hover:underline mt-0.5 block">view all items</button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-stone-900">$${(order.total || 0).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${order.status ? order.status.toUpperCase() : 'PENDING'}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                ${actions}
                            </td>
                        </tr>
                        <tr id="order-details-${id}" class="hidden bg-stone-50 border-b border-stone-100">
                            <td colspan="5" class="px-6 py-3">
                                <p class="text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">Full Order</p>
                                <div class="text-sm text-stone-800">${itemsDetail}</div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                // Toggle Red Dot
                const badge = document.getElementById('badge-orders');
                if (pendingCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                lucide.createIcons();
            });
        }

        async function updateOrderStatus(id, status) {
            try {
                if (status === 'cancelled' && !confirm("Are you sure you want to cancel this order?")) return;
                
                await db.collection('orders').doc(id).update({
                    status: status
                });
                console.log(`Order ${id} updated to ${status}`);
            } catch (error) {
                console.error("Error updating order:", error);
                alert("Could not update order.");
            }
        }

        function toggleOrderDetails(id) {
            const row = document.getElementById(`order-details-${id}`);
            if (row) row.classList.toggle('hidden');
        }

        // --- Admin Management ---

        async function loadAdmins() {
            const tableBody = document.getElementById('admins-table');
            try {
                const snapshot = await db.collection('admins').get();
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-stone-500 italic">No additional admins yet.</td></tr>';
                    return;
                }
                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const promotedAt = data.promotedAt ? new Date(data.promotedAt.toDate()).toLocaleString() : '—';
                    tableBody.innerHTML += `
                        <tr class="hover:bg-stone-50 transition-colors border-b border-stone-100">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${doc.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${promotedAt}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="removeAdmin('${doc.id}')" class="text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-3 py-1 rounded-md text-xs font-medium transition-colors">
                                    Revoke
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) {
                tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-red-600 italic">Failed to load admins.</td></tr>';
                console.error('loadAdmins error:', err);
            }
        }

        document.getElementById('promote-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('promote-email').value.trim().toLowerCase();
            const msgDiv = document.getElementById('promote-message');
            msgDiv.className = 'mt-3 text-sm p-3 rounded-md';
            msgDiv.classList.remove('hidden');
            try {
                await db.collection('admins').doc(email).set({
                    promotedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    promotedBy: auth.currentUser.email
                });
                msgDiv.textContent = `✓ ${email} has been granted admin access.`;
                msgDiv.classList.add('bg-green-50', 'text-green-800');
                document.getElementById('promote-email').value = '';
                loadAdmins();
            } catch (err) {
                msgDiv.textContent = `Error: ${err.message}`;
                msgDiv.classList.add('bg-red-50', 'text-red-800');
                console.error('Promote error:', err);
            }
            setTimeout(() => msgDiv.classList.add('hidden'), 5000);
        });

        async function removeAdmin(email) {
            if (!confirm(`Revoke admin access for ${email}?`)) return;
            try {
                await db.collection('admins').doc(email).delete();
                loadAdmins();
            } catch (err) {
                alert('Failed to revoke admin access: ' + err.message);
                console.error('removeAdmin error:', err);
            }
        }

        // --- Auth Functions ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('login-error').classList.add('hidden');
            } catch (error) {
                const errDiv = document.getElementById('login-error');
                errDiv.textContent = error.message;
                errDiv.classList.remove('hidden');
            }
        });

        function logout() { auth.signOut(); }

    </script>
</body>

</html>
